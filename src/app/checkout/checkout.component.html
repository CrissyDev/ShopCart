<div class="checkout-container" *ngIf="!success; else successMessage">
  <h1>Checkout</h1>

  <!-- Step Navigation -->
  <div class="step-navigation">
    <div [class.active]="step === 1">1. Review Order</div>
    <div [class.active]="step === 2">2. Payment Info</div>
    <div [class.active]="step === 3">3. Confirm</div>
  </div>

  <!-- Step 1: Review -->
  <div *ngIf="step === 1" class="card step-card-content step-section">
    <h2>Step 1: Review Your Order</h2>
    <ng-container *ngIf="cart?.products?.length; else emptyCart">
      <div class="cart-items-review">
        <table>
          <thead>
            <tr>
              <th>Thumbnail</th>
              <th>Title</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            
            <tr *ngFor="let item of cart?.products">
              <td><img [src]="item.thumbnail" alt="{{ item.title }}" class="thumbnail" /></td>
              <td>{{ item.title }}</td>
              <td>{{ item.quantity }}</td>
              <td>${{ formatMoney(item.price) }}</td>
              <td>${{ formatMoney(item.price * item.quantity) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="summary">
        <p><strong>Subtotal:</strong> ${{ formatMoney(subtotal) }}</p>
        <p><strong>Discount:</strong> - ${{ formatMoney(discount) }}</p>
        <p><strong>Delivery:</strong> ${{ formatMoney(deliveryFee) }}</p>
        <p><strong>Final Total:</strong> ${{ formatMoney(finalAmount) }}</p>
      </div>

      <div class="step-actions">
        <button class="back-btn" (click)="navigateToCart()">Back to Cart</button>
        <button class="active-btn" (click)="nextStep()">Continue to Payment</button>
      </div>
    </ng-container>

    <ng-template #emptyCart>
      <p>Your cart is empty. Please add products to proceed.</p>
    </ng-template>
  </div>

  <!-- Step 2: Payment Info -->
  <div *ngIf="step === 2" class="card step-card-content step-section">
    <h2>Step 2: Payment Info</h2>

    <!-- Payment Options -->
    <div class="payment-options">
      <button (click)="selectPayment('mpesa')" [class.active-payment]="selectedPaymentMethod === 'mpesa'">
        <i class="fa fa-phone"></i> M-Pesa
      </button>
      <button (click)="selectPayment('paypal')" [class.active-payment]="selectedPaymentMethod === 'paypal'">
        <i class="fa fa-smile"></i> PayPal
      </button>
      <button (click)="selectPayment('card')" [class.active-payment]="selectedPaymentMethod === 'card'">
        <i class="fa fa-credit-card"></i> Card
      </button>
    </div>

    <!-- Payment Form -->
    <form [formGroup]="paymentForm" class="payment-form">
      <ng-container [ngSwitch]="selectedPaymentMethod">
        <!-- M-Pesa -->
        <div *ngSwitchCase="'mpesa'">
          <label>Name:</label>
          <input formControlName="name" />
          <div class="text-danger" *ngIf="name?.invalid && (name?.touched || name?.dirty)">
            Name is required and must contain only letters.
          </div>

          <label>Phone Number:</label>
          <input formControlName="phone" type="tel" />
          <div class="text-danger" *ngIf="phone?.invalid && (phone?.touched || phone?.dirty)">
            Enter a valid 10-digit phone number.
          </div>
        </div>

        <!-- PayPal -->
        <div *ngSwitchCase="'paypal'">
          <label>PayPal Email:</label>
          <input formControlName="paypal" type="email" />
          <div class="text-danger" *ngIf="paypal?.invalid && (paypal?.touched || paypal?.dirty)">
            Enter a valid PayPal email address.
          </div>
        </div>

        <!-- Card -->
        <div *ngSwitchCase="'card'">
          <label>Name on Card:</label>
          <input formControlName="name" />
          <div class="text-danger" *ngIf="name?.invalid && (name?.touched || name?.dirty)">
            Name is required and must contain only letters.
          </div>

          <label>Card Number:</label>
          <input formControlName="cardNumber" mask="0000 0000 0000 0000" />
          <div class="text-danger" *ngIf="cardNumber?.invalid && (cardNumber?.touched || cardNumber?.dirty)">
            Must be 16 digits.
          </div>

          <label>Expiry Date (MM/YY):</label>
          <input formControlName="expiry" placeholder="MM/YY" />
          <div class="text-danger" *ngIf="expiry?.invalid && (expiry?.touched || expiry?.dirty)">
            Format must be MM/YY.
          </div>

          <label>CVV:</label>
          <input formControlName="cvv" maxlength="3" />
          <div class="text-danger" *ngIf="cvv?.invalid && (cvv?.touched || cvv?.dirty)">
            Must be 3 digits.
          </div>
        </div>
      </ng-container>
    </form>

    <!-- Summary and Actions -->
    <div class="summary">
      <p><strong>Total to Pay:</strong> ${{ formatMoney(finalAmount) }}</p>
    </div>

    <div class="step-actions">
      <button class="back-btn" (click)="goBack()">Back</button>
      <button
        (click)="nextStep()"
        [disabled]="paymentForm.invalid"
        [ngClass]="{
          'btn-dull-green': paymentForm.invalid,
          'btn-bright-green': paymentForm.valid
        }"
      >
        Continue to Confirm
      </button>
    </div>
  </div>

  <!-- Step 3: Confirm -->
  <div *ngIf="step === 3" class="card step-card-content step-section">
    <h2>Step 3: Confirm Your Order</h2>
    <p>Order ID: <strong>{{ orderId }}</strong></p>
    <p>Payment Method: <strong>{{ paymentMethod | uppercase }}</strong></p>
    <p>Total to Pay: <strong>KES {{ formatMoney(finalAmount) }}</strong></p>

    <div class="payment-summary">
      <h3>Payment Details</h3>
      <ng-container [ngSwitch]="paymentMethod">
        <div *ngSwitchCase="'mpesa'">
          <p><strong>Name:</strong> {{ paymentForm.get('name')?.value }}</p>
          <p><strong>Phone:</strong> {{ paymentForm.get('phone')?.value }}</p>
        </div>
        <div *ngSwitchCase="'paypal'">
          <p><strong>Email:</strong> {{ paymentForm.get('paypal')?.value }}</p>
        </div>
        <div *ngSwitchCase="'card'">
          <p><strong>Name on Card:</strong> {{ paymentForm.get('name')?.value }}</p>
          <p><strong>Card Number:</strong> **** **** **** {{ getCardLast4() }}</p>
          <p><strong>Expiry:</strong> {{ paymentForm.get('expiry')?.value }}</p>
        </div>
      </ng-container>
    </div>

    <div *ngIf="loading" class="loader-container">
      <p>Please wait as we confirm your order...</p>
      <div class="loader"></div>
    </div>

    <div class="step-actions" *ngIf="!loading">
      <button class="back-btn" (click)="goBack()">Back</button>
      <button class="active-btn" (click)="completePurchase()">Place Order</button>
    </div>
  </div>
</div>

<!-- Success Message -->
<ng-template #successMessage>
  <div class="success-message-container">
    <div class="success-message">
      <i class="fa fa-check-circle"></i>
      <h2>Order Placed Successfully!</h2>
      <p>Your order <strong>{{ orderId }}</strong> has been placed.</p>
      <p>Thank you for shopping with us!</p>
    </div>
  </div>
</ng-template>
